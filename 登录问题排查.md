# 🔧 登录问题快速排查指南

## 📊 查看后台用户数据

### 方法1：访问调试页面（推荐）
打开浏览器访问：
```
http://localhost:3000/debug
```

这个页面会显示：
- ✅ 所有已注册的用户
- ✅ 用户的邮箱、姓名、注册时间
- ✅ 密码哈希长度（验证密码是否正确加密）
- ✅ 用户总数

### 方法2：调用API接口
在浏览器访问：
```
http://localhost:3000/api/debug/users
```

会返回JSON格式的用户数据。

---

## 🐛 登录失败的常见原因

根据您的终端日志，出现了多次"登录错误: Error: 邮箱或密码错误"。可能的原因：

### 1. 内存数据丢失（最可能）⚠️
**现象**：
- 注册成功后能看到用户信息
- 刷新页面或等待一段时间后无法登录
- 终端显示"⚠️ Supabase 未配置，使用内存存储"

**原因**：
内存存储模式下，以下情况会导致数据丢失：
- Next.js 热更新（修改代码文件）
- API 路由重新编译
- 服务器重启

**解决方案**：
```bash
# 方法A：重新注册
1. 访问 http://localhost:3000/debug 查看是否有用户
2. 如果没有用户，重新注册
3. 注册后立即登录测试

# 方法B：配置 Supabase（永久解决）
参考 SUPABASE_SETUP.md 配置数据库
```

### 2. 邮箱或密码输入错误
**检查清单**：
- [ ] 邮箱是否完全匹配（区分大小写）
- [ ] 密码是否正确（至少6个字符）
- [ ] 是否有多余的空格
- [ ] 是否使用了中文输入法

**测试建议**：
使用简单的测试账号：
- 邮箱：`test@test.com`
- 密码：`123456`

### 3. 浏览器自动填充问题
**现象**：浏览器自动填充了错误的密码

**解决**：
- 清除浏览器自动填充
- 手动输入邮箱密码
- 或使用隐私模式/无痕模式

---

## 🧪 完整测试流程

### Step 1：清空环境
```bash
# 重启开发服务器
# 按 Ctrl+C 停止服务器
# 然后重新启动
npm run dev
```

### Step 2：查看当前用户
访问：`http://localhost:3000/debug`
- 如果有用户，记下邮箱
- 如果没有用户，进行下一步

### Step 3：注册新用户
1. 访问：`http://localhost:3000/register`
2. 填写信息：
   ```
   姓名：测试用户
   邮箱：test@test.com
   密码：123456
   确认密码：123456
   ```
3. 点击"注册"

### Step 4：验证注册成功
- ✅ 注册成功后应该自动跳转到首页
- ✅ 右上角显示用户名"测试用户"
- ✅ 首页显示"欢迎回来，测试用户！"

### Step 5：再次访问调试页面
访问：`http://localhost:3000/debug`
- ✅ 应该看到刚注册的用户
- ✅ 密码哈希长度应该是 60 字符

### Step 6：测试登出
1. 点击右上角头像
2. 点击"退出登录"
3. 确认退出成功

### Step 7：测试登录
1. 访问：`http://localhost:3000/login`
2. 输入刚才注册的邮箱密码：
   ```
   邮箱：test@test.com
   密码：123456
   ```
3. 点击"登录"
4. **预期结果**：登录成功，跳转到首页

---

## 📝 调试信息收集

如果问题依然存在，请收集以下信息：

### 1. 查看调试页面
访问 `http://localhost:3000/debug`，截图或记录：
- 用户总数
- 每个用户的邮箱
- 密码哈希长度

### 2. 浏览器控制台
按 `F12` 打开开发者工具，查看：
- Console 标签的错误信息
- Network 标签的 API 请求
  - 查看 `/api/auth/login` 请求
  - 查看请求体和响应

### 3. 终端日志
查看服务器终端的完整错误信息

---

## 🔍 常见错误信息解读

### "邮箱或密码错误"
**可能原因**：
1. 用户数据不存在（内存被清空）
2. 密码输入错误
3. 邮箱输入错误
4. 密码验证逻辑错误

**排查步骤**：
```bash
1. 访问 /debug 确认用户存在
2. 确认使用的是注册时的邮箱
3. 确认密码正确（至少6个字符）
4. 尝试重新注册新账号
```

### "⚠️ Supabase 未配置"
**说明**：这是正常的警告信息
- 表示系统使用内存存储模式
- 数据会在重启后丢失
- 不影响基本功能使用

**解决**：配置 Supabase 数据库（可选）

---

## 💡 建议的测试步骤

### 快速验证（5分钟）
```bash
1. 重启服务器
2. 访问 /debug 确认没有用户
3. 注册账号：test@test.com / 123456
4. 立即登出
5. 立即登录（使用相同账号）
6. 如果成功 → 系统正常 ✅
7. 如果失败 → 继续下面的调试
```

### 深度调试（10分钟）
```bash
1. 打开浏览器控制台（F12）
2. 打开 Network 标签
3. 尝试登录
4. 查看 /api/auth/login 请求
5. 检查请求体（Request）：
   - email: "test@test.com"
   - password: "123456"
6. 检查响应（Response）：
   - 成功：{ success: true, user: {...} }
   - 失败：{ success: false, message: "..." }
7. 对比调试页面的用户邮箱
```

---

## 🚀 推荐操作

### 如果只是测试功能
**保持当前配置即可**：
- 使用内存存储模式
- 每次重启后重新注册
- 注意：重启服务器会清空数据

### 如果需要数据持久化
**配置 Supabase**：
1. 参考 `SUPABASE_SETUP.md`
2. 创建 Supabase 项目
3. 执行 `supabase-schema.sql`
4. 配置环境变量
5. 重启服务器

---

## 📞 需要帮助？

如果按照上述步骤仍无法解决：

1. **提供信息**：
   - 调试页面截图
   - 浏览器控制台错误
   - 完整的登录步骤
   - 使用的邮箱密码

2. **临时方案**：
   - 每次登录前先注册
   - 不要刷新页面
   - 避免修改代码（会触发热更新）

---

**最后更新**：2025-10-28

