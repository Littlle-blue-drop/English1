# ✅ 阿里云部署配置完成清单

## 📁 新增文件

### 部署配置文件
- ✅ `Dockerfile` - Docker容器化部署配置
- ✅ `ecosystem.config.js` - PM2进程管理配置
- ✅ `nginx.conf` - Nginx反向代理配置
- ✅ `env.production.example` - 生产环境变量模板

### 部署脚本
- ✅ `deploy.sh` - 一键部署脚本
- ✅ `start.sh` - 启动脚本
- ✅ `stop.sh` - 停止脚本
- ✅ `restart.sh` - 重启脚本

### 文档
- ✅ `阿里云部署指南.md` - 完整部署指南（详细）
- ✅ `阿里云部署快速参考.md` - 快速参考手册

## 🔧 修改的文件

### 配置文件
- ✅ `next.config.js` - 添加standalone输出模式，支持服务器部署
- ✅ `package.json` - 添加PM2相关脚本命令
- ✅ `.gitignore` - 添加生产环境配置和日志文件忽略规则

### 文档
- ✅ `README.md` - 添加阿里云服务器部署章节

## 📋 部署前检查清单

### 必需配置
- [ ] 创建 `.env.production` 文件（从 `env.production.example` 复制）
- [ ] 配置所有环境变量（讯飞API、Supabase、JWT_SECRET）
- [ ] 修改 `nginx.conf` 中的域名和SSL证书路径
- [ ] 确保服务器已安装 Node.js 18+、PM2、Nginx

### 服务器准备
- [ ] Node.js 18+ 已安装
- [ ] PM2 已全局安装
- [ ] Nginx 已安装并运行
- [ ] 防火墙已配置（开放22、80、443端口）
- [ ] 域名DNS已解析到服务器IP

### SSL证书
- [ ] SSL证书已获取（Let's Encrypt或阿里云SSL）
- [ ] 证书文件已上传到服务器
- [ ] Nginx配置中证书路径正确

## 🚀 快速开始

### 1. 本地准备
```bash
# 确保所有文件已提交
git add .
git commit -m "Add Aliyun deployment configuration"
git push
```

### 2. 服务器部署
```bash
# SSH连接到服务器
ssh root@your-server-ip

# 克隆或上传代码
cd /var/www
git clone YOUR_REPO_URL voice-evaluation

# 配置环境变量
cd voice-evaluation
cp env.production.example .env.production
nano .env.production

# 安装依赖并构建
npm ci --production=false
npm run build

# 启动应用
pm2 start ecosystem.config.js
pm2 save
pm2 startup

# 配置Nginx
cp nginx.conf /etc/nginx/sites-available/voice-evaluation
# 编辑配置文件...
ln -s /etc/nginx/sites-available/voice-evaluation /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx

# 配置SSL
certbot --nginx -d your-domain.com -d www.your-domain.com
```

## 📝 环境变量说明

所有环境变量需要在 `.env.production` 文件中配置：

```env
# 讯飞语音API（必需）
NEXT_PUBLIC_XFYUN_APP_ID=your_app_id
NEXT_PUBLIC_XFYUN_API_KEY=your_api_key
NEXT_PUBLIC_XFYUN_API_SECRET=your_api_secret

# Supabase数据库（必需）
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# JWT密钥（必需，必须修改！）
JWT_SECRET=your-production-jwt-secret-change-this

# 服务器配置（可选）
NODE_ENV=production
PORT=3000
HOSTNAME=0.0.0.0
```

## 🔍 验证部署

部署完成后，访问您的域名测试：

- ✅ 首页加载正常
- ✅ HTTPS证书正常（浏览器显示🔒）
- ✅ 用户注册登录功能
- ✅ 语音评测功能
- ✅ 学习记录功能

## 📚 文档索引

- **完整指南**: `阿里云部署指南.md` - 详细的步骤说明
- **快速参考**: `阿里云部署快速参考.md` - 常用命令速查
- **README**: `README.md` - 项目总体说明

## 🛠️ 常用命令

```bash
# PM2管理
pm2 status                    # 查看状态
pm2 logs voice-evaluation-app # 查看日志
pm2 restart voice-evaluation-app # 重启

# 应用更新
cd /var/www/voice-evaluation
git pull                      # 拉取代码
npm ci --production=false     # 安装依赖
npm run build                 # 构建
pm2 restart voice-evaluation-app # 重启

# Nginx管理
systemctl reload nginx        # 重新加载配置
nginx -t                      # 测试配置
tail -f /var/log/nginx/voice-evaluation-error.log # 查看错误日志
```

## ⚠️ 注意事项

1. **安全**
   - 确保 `.env.production` 文件权限为 600
   - 不要将 `.env.production` 提交到Git仓库
   - 定期更新系统和依赖

2. **性能**
   - 根据服务器配置调整PM2实例数
   - 配置Nginx缓存以提升性能
   - 监控服务器资源使用情况

3. **备份**
   - 定期备份代码和数据库
   - 保留环境变量配置文件的安全副本

4. **日志**
   - 定期清理日志文件
   - 配置日志轮转

## 📞 获取帮助

如遇问题，请查看：
1. `阿里云部署指南.md` - 详细故障排查章节
2. PM2日志：`pm2 logs voice-evaluation-app`
3. Nginx日志：`/var/log/nginx/voice-evaluation-error.log`

---

**配置完成！现在可以开始部署了！** 🎉

