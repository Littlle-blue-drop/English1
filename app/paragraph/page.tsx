'use client';

import React, { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import { XFYunClient } from '@/lib/xfyun-client';
import { AudioRecorder } from '@/lib/audio-recorder';
import { RecordButton } from '@/components/RecordButton';
import { ScoreDisplay } from '@/components/ScoreDisplay';
import { EvaluationScore, XMLParser } from '@/lib/xml-parser';

// ç¤ºä¾‹æ®µè½åˆ—è¡¨ï¼ˆç²¾é€‰è‹±è¯­æ®µè½ï¼‰
const SAMPLE_PARAGRAPHS = [
  {
    title: "The Power of Reading",
    text: "Reading is one of the most important skills we can develop. It opens doors to new worlds, ideas, and perspectives. Through reading, we can travel to distant lands, learn about different cultures, and understand complex concepts. Books are windows to knowledge and imagination.",
  },
  {
    title: "Technology and Life",
    text: "Technology has transformed the way we live, work, and communicate. From smartphones to artificial intelligence, innovations continue to reshape our daily experiences. While technology brings convenience and efficiency, it's important to maintain balance and remember the value of human connection.",
  },
  {
    title: "Environmental Protection",
    text: "Protecting our environment is one of the greatest challenges facing humanity today. Climate change, pollution, and loss of biodiversity threaten our planet's future. Each of us has a responsibility to make sustainable choices and work together to preserve the Earth for future generations.",
  },
  {
    title: "The Value of Education",
    text: "Education is the foundation of personal and societal progress. It empowers individuals with knowledge, critical thinking skills, and opportunities for growth. Quality education not only prepares us for careers but also helps us become informed citizens who can contribute positively to our communities.",
  },
  {
    title: "Importance of Exercise",
    text: "Regular physical exercise is essential for maintaining good health and well-being. It strengthens our bodies, improves mental health, and boosts energy levels. Whether it's walking, swimming, or playing sports, finding activities we enjoy makes it easier to stay active and healthy throughout our lives.",
  },
];

export default function ParagraphPage() {
  const [currentParagraph, setCurrentParagraph] = useState(SAMPLE_PARAGRAPHS[0]);
  const [customParagraph, setCustomParagraph] = useState('');
  const [isRecording, setIsRecording] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [score, setScore] = useState<EvaluationScore | null>(null);
  const [error, setError] = useState<string>('');
  const [isSupported, setIsSupported] = useState(true);

  const recorderRef = useRef<AudioRecorder | null>(null);
  const clientRef = useRef<XFYunClient | null>(null);
  const audioChunksRef = useRef<ArrayBuffer[]>([]);
  const recordStartTimeRef = useRef<number>(0);

  useEffect(() => {
    // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
    if (!AudioRecorder.isSupported()) {
      setIsSupported(false);
      setError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Edgeç­‰ç°ä»£æµè§ˆå™¨');
    }

    // æ£€æŸ¥ç¯å¢ƒå˜é‡
    if (
      !process.env.NEXT_PUBLIC_XFYUN_APP_ID ||
      !process.env.NEXT_PUBLIC_XFYUN_API_KEY ||
      !process.env.NEXT_PUBLIC_XFYUN_API_SECRET
    ) {
      setError('è¯·é…ç½®è®¯é£APIå¯†é’¥ï¼ˆ.env.localæ–‡ä»¶ï¼‰');
    }

    return () => {
      if (recorderRef.current) {
        recorderRef.current.release();
      }
      if (clientRef.current) {
        clientRef.current.close();
      }
    };
  }, []);

  const handleStartRecord = async () => {
    try {
      setError('');
      setScore(null);
      recordStartTimeRef.current = Date.now();

      // åˆå§‹åŒ–å½•éŸ³å™¨
      recorderRef.current = new AudioRecorder();
      await recorderRef.current.init();

      // åˆå§‹åŒ–è®¯é£å®¢æˆ·ç«¯
      clientRef.current = new XFYunClient({
        appId: process.env.NEXT_PUBLIC_XFYUN_APP_ID!,
        apiKey: process.env.NEXT_PUBLIC_XFYUN_API_KEY!,
        apiSecret: process.env.NEXT_PUBLIC_XFYUN_API_SECRET!,
      });

      // è¿æ¥WebSocket - ä½¿ç”¨ read_chapter æ¨¡å¼
      await clientRef.current.connect({
        category: 'read_chapter',
        text: `[content]\n${currentParagraph.text}`,
        ent: 'en_vip',
        extra_ability: 'multi_dimension',
      });

      // ç›‘å¬è¯„æµ‹ç»“æœ
      clientRef.current.onMessage((result) => {
        if (result.code !== 0) {
          setError(`è¯„æµ‹å¤±è´¥: ${result.message} (é”™è¯¯ç : ${result.code})`);
          setIsProcessing(false);
          return;
        }

        if (result.data && result.data.status === 2) {
          // è¯„æµ‹å®Œæˆ
          const scoreData = XMLParser.parseResult(result.data.data);
          if (scoreData) {
            setScore(scoreData);
            
            // ğŸ”„ è‡ªåŠ¨ä¿å­˜ç»ƒä¹ è®°å½•åˆ°æ•°æ®åº“
            savePracticeRecord(scoreData);
          } else {
            setError('è¯„æµ‹ç»“æœè§£æå¤±è´¥');
          }
          setIsProcessing(false);
        }
      });

      // å¼€å§‹å½•éŸ³
      audioChunksRef.current = [];
      let isFirstFrame = true;

      recorderRef.current.start((audioData) => {
        audioChunksRef.current.push(audioData);
        
        // å‘é€éŸ³é¢‘æ•°æ®åˆ°è®¯é£
        if (clientRef.current) {
          clientRef.current.sendAudio(audioData, isFirstFrame, false);
          isFirstFrame = false;
        }
      });

      setIsRecording(true);
    } catch (err: any) {
      const errorMsg = err?.message || err?.toString() || 'æœªçŸ¥é”™è¯¯';
      setError(`å½•éŸ³å¯åŠ¨å¤±è´¥: ${errorMsg}`);
      console.error('å½•éŸ³å¯åŠ¨è¯¦ç»†é”™è¯¯:', err);
    }
  };

  const handleStopRecord = () => {
    if (!recorderRef.current || !clientRef.current) return;

    setIsRecording(false);
    setIsProcessing(true);

    // åœæ­¢å½•éŸ³
    recorderRef.current.stop();

    // å‘é€æœ€åä¸€å¸§
    if (audioChunksRef.current.length > 0) {
      const lastChunk = audioChunksRef.current[audioChunksRef.current.length - 1];
      clientRef.current.sendAudio(lastChunk, false, true);
    }

    // é‡Šæ”¾èµ„æº
    recorderRef.current.release();
    recorderRef.current = null;
  };

  const handleParagraphSelect = (paragraph: typeof SAMPLE_PARAGRAPHS[0]) => {
    setCurrentParagraph(paragraph);
    setScore(null);
    setError('');
  };

  const handleCustomParagraphSubmit = () => {
    if (customParagraph.trim()) {
      setCurrentParagraph({
        title: 'è‡ªå®šä¹‰æ®µè½',
        text: customParagraph.trim(),
      });
      setCustomParagraph('');
      setScore(null);
      setError('');
    }
  };

  // ğŸ†• ä¿å­˜ç»ƒä¹ è®°å½•åˆ°æ•°æ®åº“
  const savePracticeRecord = async (scoreData: EvaluationScore) => {
    try {
      const duration = Math.floor((Date.now() - recordStartTimeRef.current) / 1000);

      const response = await fetch('/api/practice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type: 'paragraph',
          content: currentParagraph.text,
          total_score: scoreData.totalScore,
          accuracy: scoreData.accuracyScore || 0,
          fluency: scoreData.fluencyScore || 0,
          integrity: scoreData.integrityScore || 0,
          standard: scoreData.standardScore || 0,
          word_details: scoreData.sentences,
          raw_result: scoreData,
          duration,
        }),
      });

      if (!response.ok) {
        console.warn('ä¿å­˜ç»ƒä¹ è®°å½•å¤±è´¥');
      } else {
        console.log('âœ… ç»ƒä¹ è®°å½•å·²ä¿å­˜');
      }
    } catch (error) {
      console.error('ä¿å­˜ç»ƒä¹ è®°å½•é”™è¯¯:', error);
    }
  };

  return (
    <main className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 py-8">
      <div className="container mx-auto px-4 max-w-6xl">
        {/* å¤´éƒ¨ */}
        <div className="mb-8">
          <Link href="/" className="text-purple-600 hover:text-purple-700 flex items-center mb-4">
            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            è¿”å›é¦–é¡µ
          </Link>
          <h1 className="text-4xl font-bold text-gray-800">ğŸ“„ æ®µè½æœ—è¯»</h1>
          <p className="text-gray-600 mt-2">é€‰æ‹©æˆ–è¾“å…¥æ®µè½ï¼ŒæŒ‘æˆ˜æ›´é•¿ç¯‡å¹…çš„æœ—è¯»ç»ƒä¹ </p>
        </div>

        {/* é”™è¯¯æç¤º */}
        {error && (
          <div className="mb-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            {error}
          </div>
        )}

        {/* æ®µè½é€‰æ‹© */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h2 className="text-xl font-semibold mb-4">é€‰æ‹©æ®µè½</h2>
          <div className="grid md:grid-cols-2 gap-3 mb-4">
            {SAMPLE_PARAGRAPHS.map((paragraph, idx) => (
              <button
                key={idx}
                onClick={() => handleParagraphSelect(paragraph)}
                className={`px-4 py-3 rounded-lg text-left transition-all ${
                  currentParagraph.title === paragraph.title
                    ? 'bg-purple-500 text-white shadow-lg'
                    : 'bg-gray-50 text-gray-700 hover:bg-gray-100 border border-gray-200'
                }`}
              >
                <div className="font-semibold mb-1">{paragraph.title}</div>
                <div className="text-sm opacity-75 line-clamp-2">{paragraph.text}</div>
              </button>
            ))}
          </div>

          {/* è‡ªå®šä¹‰æ®µè½ */}
          <div className="flex flex-col gap-2">
            <textarea
              value={customParagraph}
              onChange={(e) => setCustomParagraph(e.target.value)}
              placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰æ®µè½ï¼ˆæ”¯æŒå¤šå¥ï¼‰..."
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
              rows={4}
            />
            <button
              onClick={handleCustomParagraphSubmit}
              className="self-end px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
            >
              ä½¿ç”¨æ­¤æ®µè½
            </button>
          </div>
        </div>

        {/* å½“å‰æ®µè½æ˜¾ç¤º */}
        <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
          <h3 className="text-2xl font-bold text-purple-700 mb-4">{currentParagraph.title}</h3>
          <div className="text-lg md:text-xl text-gray-700 leading-relaxed whitespace-pre-wrap">
            {currentParagraph.text}
          </div>
          <div className="text-gray-500 text-center mt-6">è¯·æœ—è¯»ä¸Šé¢çš„æ®µè½</div>
        </div>

        {/* å½•éŸ³æŒ‰é’® */}
        <div className="bg-white rounded-lg shadow-lg p-8 mb-6 flex justify-center">
          <RecordButton
            isRecording={isRecording}
            isProcessing={isProcessing}
            onStartRecord={handleStartRecord}
            onStopRecord={handleStopRecord}
            disabled={!isSupported}
          />
        </div>

        {/* è¯„åˆ†å±•ç¤º */}
        {score && (
          <div className="mb-6">
            <ScoreDisplay score={score} showDetails={true} />
          </div>
        )}

        {/* è¯„æµ‹è¯´æ˜ */}
        <div className="bg-white rounded-lg shadow-lg p-6">
          <h3 className="text-lg font-semibold mb-3 text-gray-800">ğŸ“Š æ®µè½æœ—è¯»è¯„æµ‹è¯´æ˜</h3>
          <div className="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
            <div>
              <strong className="text-blue-600">å‡†ç¡®åº¦ (60%)</strong>
              <p className="mt-1">å•è¯å‘éŸ³çš„å‡†ç¡®æ€§ï¼Œæ®µè½è¶Šé•¿ï¼ŒæŒ‘æˆ˜è¶Šå¤§</p>
            </div>
            <div>
              <strong className="text-green-600">æµç•…åº¦ (30%)</strong>
              <p className="mt-1">æ•´ä½“æœ—è¯»çš„æµç•…ç¨‹åº¦ï¼Œè€ƒå¯Ÿè¯­é€Ÿå’Œåœé¡¿</p>
            </div>
            <div>
              <strong className="text-purple-600">æ ‡å‡†åº¦ (10%)</strong>
              <p className="mt-1">å‘éŸ³ä¹ æƒ¯æ˜¯å¦ç¬¦åˆè‹±è¯­æ¯è¯­æ ‡å‡†</p>
            </div>
            <div>
              <strong className="text-orange-600">å®Œæ•´åº¦</strong>
              <p className="mt-1">æ˜¯å¦å®Œæ•´æœ—è¯»æ‰€æœ‰å†…å®¹ï¼Œæœ‰æ— é—æ¼</p>
            </div>
          </div>
          <div className="mt-4 p-4 bg-purple-50 rounded-lg">
            <p className="text-sm text-purple-800">
              ğŸ’¡ <strong>å°æç¤ºï¼š</strong>æ®µè½æœ—è¯»æ›´è€ƒéªŒæ•´ä½“è¡¨ç°åŠ›ã€‚å»ºè®®å…ˆç†Ÿè¯»æ–‡æœ¬ï¼Œæ³¨æ„å¥å­ä¹‹é—´çš„è¿è´¯æ€§å’Œæƒ…æ„Ÿè¡¨è¾¾ã€‚
              å½•éŸ³å‰æ·±å‘¼å¸ï¼Œä¿æŒå¹³ç¨³çš„è¯­é€Ÿï¼Œä¸è¦æ€¥äºæ±‚æˆã€‚
            </p>
          </div>
        </div>
      </div>
    </main>
  );
}

