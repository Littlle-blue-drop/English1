# ğŸš€ é˜¿é‡Œäº‘æœåŠ¡å™¨éƒ¨ç½²å®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£å°†æŒ‡å¯¼æ‚¨å®Œæˆåœ¨é˜¿é‡Œäº‘ECSæœåŠ¡å™¨ä¸Šéƒ¨ç½²AIè¯­éŸ³è¯„æµ‹ç³»ç»Ÿçš„å®Œæ•´æµç¨‹ã€‚

---

## ğŸ“‹ å‰ç½®å‡†å¤‡

### âœ… å¿…éœ€èµ„æº
- [ ] **é˜¿é‡Œäº‘ECSæœåŠ¡å™¨** - æ¨èé…ç½®ï¼š2æ ¸4Gï¼ŒUbuntu 20.04/22.04 æˆ– CentOS 7/8
- [ ] **åŸŸå** - å·²å¤‡æ¡ˆçš„åŸŸåï¼ˆå›½å†…æœåŠ¡å™¨éœ€è¦ï¼‰
- [ ] **SSLè¯ä¹¦** - é˜¿é‡Œäº‘SSLè¯ä¹¦æˆ–Let's Encryptå…è´¹è¯ä¹¦
- [ ] **Supabaseé¡¹ç›®** - å·²å®Œæˆæ•°æ®åº“é…ç½®
- [ ] **è®¯é£APIå¯†é’¥** - å·²è·å–APPIDã€APIKeyã€APISecret

### ğŸ“ æœåŠ¡å™¨ä¿¡æ¯æ¸…å•
è¯·å‡†å¤‡å¥½ä»¥ä¸‹ä¿¡æ¯ï¼š
```
âœ… æœåŠ¡å™¨å…¬ç½‘IP: xxx.xxx.xxx.xxx
âœ… æœåŠ¡å™¨SSHç™»å½•ç”¨æˆ·åå’Œå¯†ç ï¼ˆæˆ–å¯†é’¥ï¼‰
âœ… åŸŸå: your-domain.com
âœ… åŸŸåDNSè§£æå·²é…ç½®åˆ°æœåŠ¡å™¨IP
âœ… SSLè¯ä¹¦æ–‡ä»¶è·¯å¾„
```

---

## ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1.1 è¿æ¥åˆ°æœåŠ¡å™¨

ä½¿ç”¨SSHè¿æ¥åˆ°æ‚¨çš„é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼š

```bash
ssh root@your-server-ip
# æˆ–ä½¿ç”¨å¯†é’¥
ssh -i your-key.pem root@your-server-ip
```

### 1.2 æ›´æ–°ç³»ç»Ÿ

```bash
# Ubuntu/Debian
apt update && apt upgrade -y

# CentOS/RHEL
yum update -y
```

### 1.3 å®‰è£…Node.js 18+

**æ–¹æ³•1ï¼šä½¿ç”¨NodeSourceï¼ˆæ¨èï¼‰**

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs
```

**æ–¹æ³•2ï¼šä½¿ç”¨NVM**

```bash
# å®‰è£…NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# å®‰è£…Node.js 18
nvm install 18
nvm use 18
nvm alias default 18
```

éªŒè¯å®‰è£…ï¼š
```bash
node -v  # åº”æ˜¾ç¤º v18.x.x
npm -v   # åº”æ˜¾ç¤º 9.x.x
```

### 1.4 å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨

```bash
npm install -g pm2
```

### 1.5 å®‰è£…Nginxï¼ˆç”¨äºåå‘ä»£ç†å’ŒSSLï¼‰

```bash
# Ubuntu/Debian
apt install -y nginx

# CentOS/RHEL
yum install -y nginx

# å¯åŠ¨Nginx
systemctl start nginx
systemctl enable nginx
```

### 1.6 é…ç½®é˜²ç«å¢™

```bash
# Ubuntu/Debian (UFW)
ufw allow 22/tcp   # SSH
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS
ufw enable

# CentOS/RHEL (firewalld)
firewall-cmd --permanent --add-service=ssh
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

---

## ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²åº”ç”¨ä»£ç 

### 2.1 åˆ›å»ºåº”ç”¨ç›®å½•

```bash
mkdir -p /var/www/voice-evaluation
cd /var/www/voice-evaluation
```

### 2.2 ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨

**æ–¹æ³•1ï¼šä½¿ç”¨Gitï¼ˆæ¨èï¼‰**

```bash
# å®‰è£…Git
apt install -y git  # Ubuntu/Debian
# æˆ–
yum install -y git  # CentOS/RHEL

# å…‹éš†ä»“åº“ï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„GitHubä»“åº“åœ°å€ï¼‰
git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git .
```

**æ–¹æ³•2ï¼šä½¿ç”¨SCPä»æœ¬åœ°ä¸Šä¼ **

åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œï¼š
```bash
scp -r ./voice-evaluation-mvp/* root@your-server-ip:/var/www/voice-evaluation/
```

**æ–¹æ³•3ï¼šä½¿ç”¨rsyncï¼ˆæ¨èç”¨äºå¤§æ–‡ä»¶ï¼‰**

```bash
rsync -avz --exclude 'node_modules' --exclude '.next' ./voice-evaluation-mvp/ root@your-server-ip:/var/www/voice-evaluation/
```

### 2.3 å®‰è£…ä¾èµ–

```bash
cd /var/www/voice-evaluation
npm ci --production=false
```

---

## ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

### 3.1 åˆ›å»ºç”Ÿäº§ç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
cp env.production.example .env.production
nano .env.production  # æˆ–ä½¿ç”¨ vi
```

### 3.2 é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env.production` æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„å®é™…å€¼ï¼š

```env
# è®¯é£è¯­éŸ³APIé…ç½®
NEXT_PUBLIC_XFYUN_APP_ID=your_app_id
NEXT_PUBLIC_XFYUN_API_KEY=your_api_key
NEXT_PUBLIC_XFYUN_API_SECRET=your_api_secret

# JWTå¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
JWT_SECRET=your-production-jwt-secret-change-this

# Supabaseé…ç½®
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# æœåŠ¡å™¨é…ç½®
NODE_ENV=production
PORT=3000
HOSTNAME=0.0.0.0
```

**âš ï¸ é‡è¦ï¼š**
- ç¡®ä¿ `JWT_SECRET` æ˜¯å¼ºéšæœºå­—ç¬¦ä¸²ï¼ˆ32+å­—ç¬¦ï¼‰
- å¯ä»¥ä½¿ç”¨å‘½ä»¤ç”Ÿæˆï¼š`node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`
- ä¿å­˜æ–‡ä»¶ï¼š`Ctrl+O`ï¼Œé€€å‡ºï¼š`Ctrl+X`ï¼ˆnanoç¼–è¾‘å™¨ï¼‰

### 3.3 è®¾ç½®ç¯å¢ƒå˜é‡æƒé™

```bash
chmod 600 .env.production
chown root:root .env.production
```

---

## ç¬¬å››æ­¥ï¼šæ„å»ºå’Œå¯åŠ¨åº”ç”¨

### 4.1 æ„å»ºåº”ç”¨

```bash
npm run build
```

### 4.2 ä½¿ç”¨PM2å¯åŠ¨åº”ç”¨

```bash
# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®PM2å¼€æœºè‡ªå¯
pm2 startup
# æ‰§è¡Œä¸Šé¢å‘½ä»¤è¾“å‡ºçš„å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ sudo env PATH=...ï¼‰
```

### 4.3 éªŒè¯åº”ç”¨è¿è¡Œ

```bash
# æŸ¥çœ‹PM2çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs voice-evaluation-app

# æµ‹è¯•æœ¬åœ°è®¿é—®
curl http://localhost:3000
```

---

## ç¬¬äº”æ­¥ï¼šé…ç½®Nginxåå‘ä»£ç†

### 5.1 å¤åˆ¶Nginxé…ç½®æ–‡ä»¶

```bash
cp nginx.conf /etc/nginx/sites-available/voice-evaluation
# æˆ–
cp nginx.conf /etc/nginx/conf.d/voice-evaluation.conf
```

### 5.2 ç¼–è¾‘Nginxé…ç½®

```bash
nano /etc/nginx/sites-available/voice-evaluation
```

**ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š**
- `your-domain.com` â†’ æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸå
- SSLè¯ä¹¦è·¯å¾„ â†’ æ›¿æ¢ä¸ºæ‚¨çš„è¯ä¹¦è·¯å¾„

### 5.3 å¯ç”¨é…ç½®

```bash
# å¦‚æœä½¿ç”¨sites-available
ln -s /etc/nginx/sites-available/voice-evaluation /etc/nginx/sites-enabled/

# æµ‹è¯•Nginxé…ç½®
nginx -t

# é‡æ–°åŠ è½½Nginx
systemctl reload nginx
```

---

## ç¬¬å…­æ­¥ï¼šé…ç½®SSLè¯ä¹¦

### æ–¹æ³•1ï¼šä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦ï¼ˆæ¨èï¼‰

```bash
# å®‰è£…Certbot
apt install -y certbot python3-certbot-nginx  # Ubuntu/Debian
# æˆ–
yum install -y certbot python3-certbot-nginx  # CentOS/RHEL

# è·å–è¯ä¹¦ï¼ˆè‡ªåŠ¨é…ç½®Nginxï¼‰
certbot --nginx -d your-domain.com -d www.your-domain.com

# è¯ä¹¦ä¼šè‡ªåŠ¨ç»­æœŸï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æµ‹è¯•
certbot renew --dry-run
```

### æ–¹æ³•2ï¼šä½¿ç”¨é˜¿é‡Œäº‘SSLè¯ä¹¦

1. åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°ç”³è¯·SSLè¯ä¹¦
2. ä¸‹è½½è¯ä¹¦æ–‡ä»¶ï¼ˆNginxæ ¼å¼ï¼‰
3. ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š
   ```bash
   mkdir -p /etc/nginx/ssl
   # ä¸Šä¼ è¯ä¹¦æ–‡ä»¶åˆ°æ­¤ç›®å½•
   # your-domain.com.crt
   # your-domain.com.key
   ```
4. åœ¨Nginxé…ç½®ä¸­æŒ‡å®šè¯ä¹¦è·¯å¾„

---

## ç¬¬ä¸ƒæ­¥ï¼šé…ç½®åŸŸåDNSè§£æ

åœ¨æ‚¨çš„åŸŸåDNSç®¡ç†é¢æ¿ï¼ˆé˜¿é‡Œäº‘DNSæˆ–å…¶ä»–ï¼‰æ·»åŠ ä»¥ä¸‹è®°å½•ï¼š

### Aè®°å½•ï¼ˆæ¨èï¼‰
```
ç±»å‹: A
ä¸»æœºè®°å½•: @
è®°å½•å€¼: æ‚¨çš„æœåŠ¡å™¨å…¬ç½‘IP
TTL: 600
```

### æ·»åŠ WWWè®°å½•
```
ç±»å‹: A
ä¸»æœºè®°å½•: www
è®°å½•å€¼: æ‚¨çš„æœåŠ¡å™¨å…¬ç½‘IP
TTL: 600
```

ç­‰å¾…DNSç”Ÿæ•ˆï¼ˆé€šå¸¸å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ï¼‰

---

## ç¬¬å…«æ­¥ï¼šéªŒè¯éƒ¨ç½²

### 8.1 è®¿é—®ç½‘ç«™

åœ¨æµè§ˆå™¨è®¿é—®ï¼š`https://your-domain.com`

### 8.2 åŠŸèƒ½æµ‹è¯•æ¸…å•

- [ ] âœ… é¦–é¡µæ­£å¸¸åŠ è½½
- [ ] âœ… HTTPSè¯ä¹¦æ­£å¸¸ï¼ˆæµè§ˆå™¨æ˜¾ç¤ºğŸ”’ï¼‰
- [ ] âœ… ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½
- [ ] âœ… ç”¨æˆ·ç™»å½•åŠŸèƒ½
- [ ] âœ… è¯­éŸ³è¯„æµ‹åŠŸèƒ½ï¼ˆå•è¯ã€å¥å­ã€æ®µè½ï¼‰
- [ ] âœ… å­¦ä¹ è®°å½•åŠŸèƒ½
- [ ] âœ… ç§»åŠ¨ç«¯è®¿é—®æ­£å¸¸

### 8.3 æ£€æŸ¥æ—¥å¿—

```bash
# åº”ç”¨æ—¥å¿—
pm2 logs voice-evaluation-app

# Nginxè®¿é—®æ—¥å¿—
tail -f /var/log/nginx/voice-evaluation-access.log

# Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/voice-evaluation-error.log
```

---

## å¸¸ç”¨ç®¡ç†å‘½ä»¤

### PM2ç®¡ç†

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs voice-evaluation-app

# é‡å¯åº”ç”¨
pm2 restart voice-evaluation-app

# åœæ­¢åº”ç”¨
pm2 stop voice-evaluation-app

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 info voice-evaluation-app

# ç›‘æ§
pm2 monit
```

### åº”ç”¨æ›´æ–°

```bash
cd /var/www/voice-evaluation

# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨Gitï¼‰
git pull origin main

# å®‰è£…æ–°ä¾èµ–
npm ci --production=false

# é‡æ–°æ„å»º
npm run build

# é‡å¯åº”ç”¨
pm2 restart voice-evaluation-app
```

### Nginxç®¡ç†

```bash
# é‡æ–°åŠ è½½é…ç½®ï¼ˆä¸ä¸­æ–­æœåŠ¡ï¼‰
systemctl reload nginx

# é‡å¯Nginx
systemctl restart nginx

# æŸ¥çœ‹çŠ¶æ€
systemctl status nginx

# æµ‹è¯•é…ç½®
nginx -t
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šåº”ç”¨æ— æ³•å¯åŠ¨

**æ£€æŸ¥ï¼š**
```bash
# æŸ¥çœ‹PM2æ—¥å¿—
pm2 logs voice-evaluation-app --lines 50

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 3000

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cat .env.production
```

### é—®é¢˜2ï¼š502 Bad Gateway

**å¯èƒ½åŸå› ï¼š**
- Next.jsåº”ç”¨æœªå¯åŠ¨
- ç«¯å£é…ç½®é”™è¯¯
- Nginxé…ç½®é”™è¯¯

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥åº”ç”¨çŠ¶æ€
pm2 status

# æ£€æŸ¥Nginxé…ç½®
nginx -t

# æ£€æŸ¥Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/voice-evaluation-error.log
```

### é—®é¢˜3ï¼šSSLè¯ä¹¦é”™è¯¯

**æ£€æŸ¥ï¼š**
```bash
# æ£€æŸ¥è¯ä¹¦æ–‡ä»¶
ls -la /etc/nginx/ssl/

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
openssl x509 -in /etc/nginx/ssl/your-domain.com.crt -noout -dates

# æµ‹è¯•SSLé…ç½®
openssl s_client -connect your-domain.com:443
```

### é—®é¢˜4ï¼šç¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆ

**è§£å†³ï¼š**
```bash
# ç¡®ä¿.env.productionæ–‡ä»¶å­˜åœ¨
ls -la .env.production

# é‡å¯åº”ç”¨
pm2 restart voice-evaluation-app

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦åŠ è½½
pm2 env voice-evaluation-app
```

### é—®é¢˜5ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**æ£€æŸ¥ï¼š**
- Supabase URLå’Œå¯†é’¥æ˜¯å¦æ­£ç¡®
- æœåŠ¡å™¨èƒ½å¦è®¿é—®Supabaseï¼ˆå¯èƒ½è¢«é˜²ç«å¢™é˜»æ­¢ï¼‰
- æ£€æŸ¥Supabaseé¡¹ç›®çš„ç½‘ç»œè®¿é—®è®¾ç½®

```bash
# æµ‹è¯•è¿æ¥
curl https://your-project.supabase.co
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å¯ç”¨Gzipå‹ç¼©

å·²åœ¨Nginxé…ç½®ä¸­å¯ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

### 2. é…ç½®CDNï¼ˆå¯é€‰ï¼‰

å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘CDNåŠ é€Ÿé™æ€èµ„æºï¼š
- åœ¨é˜¿é‡Œäº‘CDNæ§åˆ¶å°æ·»åŠ åŸŸå
- é…ç½®æºç«™ä¸ºæ‚¨çš„æœåŠ¡å™¨IP
- æ›´æ–°DNSè§£ææŒ‡å‘CDN

### 3. æ•°æ®åº“è¿æ¥æ± ï¼ˆå¦‚æœä½¿ç”¨ï¼‰

å¦‚æœè¿æ¥æ•°è¾ƒå¤šï¼Œè€ƒè™‘åœ¨Supabaseé…ç½®è¿æ¥æ± ã€‚

### 4. ç›‘æ§å’Œå‘Šè­¦

å»ºè®®é…ç½®ï¼š
- æœåŠ¡å™¨ç›‘æ§ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
- åº”ç”¨ç›‘æ§ï¼ˆPM2ç›‘æ§ï¼‰
- æ—¥å¿—æ”¶é›†ï¼ˆå¦‚ELKã€é˜¿é‡Œäº‘æ—¥å¿—æœåŠ¡ï¼‰

---

## å®‰å…¨å»ºè®®

### 1. å®šæœŸæ›´æ–°

```bash
# æ›´æ–°ç³»ç»Ÿ
apt update && apt upgrade -y  # Ubuntu/Debian
yum update -y  # CentOS/RHEL

# æ›´æ–°Node.jsä¾èµ–
npm audit fix
```

### 2. é˜²ç«å¢™é…ç½®

åªå¼€æ”¾å¿…è¦ç«¯å£ï¼š22ï¼ˆSSHï¼‰ã€80ï¼ˆHTTPï¼‰ã€443ï¼ˆHTTPSï¼‰

### 3. SSHå®‰å…¨

- ç¦ç”¨rootç™»å½•
- ä½¿ç”¨å¯†é’¥è®¤è¯
- æ›´æ”¹SSHç«¯å£

### 4. å®šæœŸå¤‡ä»½

```bash
# å¤‡ä»½ä»£ç 
tar -czf backup-$(date +%Y%m%d).tar.gz /var/www/voice-evaluation

# å¤‡ä»½æ•°æ®åº“ï¼ˆSupabaseæœ‰è‡ªåŠ¨å¤‡ä»½ï¼‰
```

### 5. æ—¥å¿—ç®¡ç†

å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…ç£ç›˜æ»¡ï¼š
```bash
# æ¸…ç†PM2æ—¥å¿—
pm2 flush

# æ¸…ç†Nginxæ—¥å¿—ï¼ˆé…ç½®logrotateï¼‰
```

---

## ğŸ“Š æœåŠ¡å™¨èµ„æºç›‘æ§

### æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
# CPUå’Œå†…å­˜
htop  # æˆ– top

# ç£ç›˜ä½¿ç”¨
df -h

# ç½‘ç»œæµé‡
iftop
```

### PM2ç›‘æ§

```bash
pm2 monit
```

---

## ğŸ‰ éƒ¨ç½²å®Œæˆï¼

æ­å–œï¼æ‚¨çš„åº”ç”¨ç°åœ¨å·²ç»ï¼š

- âœ… è¿è¡Œåœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Š
- âœ… é€šè¿‡åŸŸåè®¿é—®ï¼ˆHTTPSåŠ å¯†ï¼‰
- âœ… è‡ªåŠ¨é‡å¯å’Œè¿›ç¨‹ç®¡ç†
- âœ… åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**ï¼š`pm2 logs` å’Œ `nginxé”™è¯¯æ—¥å¿—`
2. **æ£€æŸ¥é…ç½®**ï¼šç¯å¢ƒå˜é‡ã€Nginxé…ç½®
3. **æµ‹è¯•è¿æ¥**ï¼šæœ¬åœ°æµ‹è¯•ã€DNSè§£æ
4. **é˜¿é‡Œäº‘å·¥å•**ï¼šæœåŠ¡å™¨ç›¸å…³é—®é¢˜

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸš€

